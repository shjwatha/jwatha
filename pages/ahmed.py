
# ========== Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ==========
if selected_tab == "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡":
    st.header("ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡")

    st.markdown("""
    ### ğŸ“Œ Ø¥Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:
    """)

    choice = st.selectbox("Ù†ÙˆØ¹ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡", ["Ø§Ù„Ù…Ø³ØªÙˆÙ‰", "Ø§Ù„Ø¢Ø¯Ù…Ù†", "Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø´Ø±Ù", "Ø§Ù„Ù…Ø´Ø±Ù", "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"], key="user_filter")

    admins, users = [], []

    if choice == "Ø§Ù„Ù…Ø³ØªÙˆÙ‰":
        selected_level = st.selectbox("Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰", [lvl['level_name'] for lvl in levels], key="view_level")
        cursor.execute("SELECT * FROM admins WHERE level = %s AND is_deleted = FALSE", (selected_level,))
        admins = cursor.fetchall()
        cursor.execute("SELECT * FROM users WHERE level = %s AND is_deleted = FALSE", (selected_level,))
        users = cursor.fetchall()

    elif choice in ["Ø§Ù„Ø¢Ø¯Ù…Ù†", "Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø´Ø±Ù", "Ø§Ù„Ù…Ø´Ø±Ù"]:
        role_map = {
            "Ø§Ù„Ø¢Ø¯Ù…Ù†": "admin",
            "Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø´Ø±Ù": "sp",
            "Ø§Ù„Ù…Ø´Ø±Ù": "supervisor"
        }
        role = role_map[choice]
        cursor.execute("SELECT * FROM admins WHERE role = %s AND is_deleted = FALSE", (role,))
        admins = cursor.fetchall()

    elif choice == "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…":
        cursor.execute("SELECT * FROM users WHERE is_deleted = FALSE")
        users = cursor.fetchall()

    # Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ù…Ø¹ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ…
    if admins:
        st.subheader("ğŸ‘¨â€ğŸ’¼ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠÙˆÙ†")
        for admin in admins:
            with st.expander(f"ğŸ‘¤ {admin['full_name']} - {admin['username']} ({admin['role']})"):
                st.markdown(f"Ø§Ù„Ù…Ø³ØªÙˆÙ‰: {admin['level']}")
                col1, col2 = st.columns([1, 1])
                with col1:
                    if st.button(f"ğŸ“ ØªØ¹Ø¯ÙŠÙ„ {admin['username']}", key=f"edit_admin_{admin['id']}"):
                        new_full_name = st.text_input("Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„", value=admin['full_name'])
                        level_names = [lvl['level_name'] for lvl in levels]
                        new_level = st.selectbox("Ø§Ù„Ù…Ø³ØªÙˆÙ‰", level_names, index=level_names.index(admin['level']) if admin['level'] in level_names else 0)
                        role_names = ["admin", "sp", "supervisor"]
                        new_role = st.selectbox("Ø§Ù„Ø¯ÙˆØ±", role_names, index=role_names.index(admin['role']) if admin['role'] in role_names else 0)
                        if st.button(f"ØªØ­Ø¯ÙŠØ«"):
                            cursor.execute("UPDATE admins SET full_name = %s, level = %s, role = %s WHERE id = %s", (new_full_name, new_level, new_role, admin['id']))
                            conn.commit()
                            st.success("âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«")
                            st.rerun()
                with col2:
                    if st.button(f"ğŸ—‘ï¸ Ø­Ø°Ù {admin['username']}", key=f"delete_admin_{admin['id']}"):
                        cursor.execute("UPDATE admins SET is_deleted = TRUE WHERE id = %s", (admin['id'],))
                        conn.commit()
                        st.success("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ")
                        st.rerun()

    if users:
        st.subheader("ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†")
        for user in users:
            with st.expander(f"ğŸ‘¤ {user['full_name']} - {user['username']}"):
                st.markdown(f"Ø§Ù„Ù…Ø³ØªÙˆÙ‰: {user['level']} | Ø§Ù„Ù…Ø´Ø±Ù: {user['mentor']}")
                col1, col2 = st.columns([1, 1])
                with col1:
                    if st.button(f"ğŸ“ ØªØ¹Ø¯ÙŠÙ„ {user['username']}", key=f"edit_user_{user['id']}"):
                        new_full_name = st.text_input("Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„", value=user['full_name'])
                        level_names = [lvl['level_name'] for lvl in levels]
                        new_level = st.selectbox("Ø§Ù„Ù…Ø³ØªÙˆÙ‰", level_names, index=level_names.index(user['level']) if user['level'] in level_names else 0)
                        new_mentor = st.selectbox("Ø§Ù„Ù…Ø´Ø±Ù", [user['mentor'] for user in users])
                        if st.button(f"ØªØ­Ø¯ÙŠØ«"):
                            cursor.execute("UPDATE users SET full_name = %s, level = %s, mentor = %s WHERE id = %s", (new_full_name, new_level, new_mentor, user['id']))
                            conn.commit()
                            st.success("âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«")
                            st.rerun()
                with col2:
                    if st.button(f"ğŸ—‘ï¸ Ø­Ø°Ù {user['username']}", key=f"delete_user_{user['id']}"):
                        cursor.execute("UPDATE users SET is_deleted = TRUE WHERE id = %s", (user['id'],))
                        conn.commit()
                        st.success("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
                        st.rerun()

    # ğŸ§‘â€ğŸ’¼ Ø¥Ø¶Ø§ÙØ© Ø¢Ø¯Ù…Ù† Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ø³ØªÙˆÙ‰
    st.subheader("ğŸ§‘â€ğŸ’¼ Ø¥Ø¶Ø§ÙØ© Ù…Ø¯ÙŠØ± Ù„Ù„Ù…Ø³ØªÙˆÙ‰")
    with st.form("add_admin"):
        full_name = st.text_input("Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø¢Ø¯Ù…Ù†")
        username = st.text_input("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
        password = st.text_input("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", type="password")
        level_options = [lvl['level_name'] for lvl in levels]
        level = st.selectbox("Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰", level_options)
        submit_admin = st.form_submit_button("â• Ø¥Ø¶Ø§ÙØ©")

        if submit_admin:
            cursor.execute("SELECT * FROM admins WHERE username = %s", (username,))
            if cursor.fetchone():
                st.warning("âš ï¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ù‹Ø§.")
            else:
                cursor.execute(
                    "INSERT INTO admins (full_name, username, password, role, level) VALUES (%s, %s, %s, %s, %s)",
                    (full_name, username, password, 'admin', level)
                )
                conn.commit()
                st.success("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¢Ø¯Ù…Ù†")
                st.rerun()

    # ğŸ‘¨â€ğŸ« Ø¥Ø¶Ø§ÙØ© Ø³ÙˆØ¨Ø± Ù…Ø´Ø±Ù
    st.subheader("ğŸ‘¨â€ğŸ« Ø¥Ø¶Ø§ÙØ© Ø³ÙˆØ¨Ø± Ù…Ø´Ø±Ù")
    with st.form("add_sp"):
        full_name = st.text_input("Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø³ÙˆØ¨Ø± Ù…Ø´Ø±Ù")
        username = st.text_input("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
        password = st.text_input("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", type="password")
        level = st.selectbox("Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù„Ù„Ø³ÙˆØ¨Ø± Ù…Ø´Ø±Ù", level_options, key="sp_level")
        submit_sp = st.form_submit_button("â• Ø¥Ø¶Ø§ÙØ© Ø³ÙˆØ¨Ø± Ù…Ø´Ø±Ù")

        if submit_sp:
            cursor.execute("SELECT * FROM admins WHERE username = %s", (username,))
            if cursor.fetchone():
                st.warning("âš ï¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§.")
            else:
                cursor.execute(
                    "INSERT INTO admins (full_name, username, password, role, level) VALUES (%s, %s, %s, %s, %s)",
                    (full_name, username, password, 'sp', level)
                )
                conn.commit()
                st.success("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø´Ø±Ù")
                st.rerun()

    # ğŸ‘¨â€ğŸ’¼ Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±Ù Ù…Ø±ØªØ¨Ø· Ø¨Ø³ÙˆØ¨Ø± Ù…Ø´Ø±Ù
    st.subheader("ğŸ‘¨â€ğŸ’¼ Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±Ù")
    cursor.execute("SELECT username, full_name, level FROM admins WHERE role = 'sp' AND is_deleted = FALSE")
    supervisors = cursor.fetchall()
    if not supervisors:
        st.info("ğŸ”¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³ÙˆØ¨Ø± Ù…Ø´Ø±ÙÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.")
    else:
        with st.form("add_supervisor"):
            full_name = st.text_input("Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù")
            username = st.text_input("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù…Ø´Ø±Ù")
            password = st.text_input("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø´Ø±Ù", type="password")
            selected_sp = st.selectbox("Ø§Ø®ØªØ± Ø³ÙˆØ¨Ø± Ù…Ø´Ø±Ù", [f"{s['full_name']} ({s['username']})" for s in supervisors])
            sp_username = selected_sp.split("(")[-1].replace(")", "").strip()
            sp_level = next((s['level'] for s in supervisors if s['username'] == sp_username), None)
            submit_sup = st.form_submit_button("â• Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±Ù")

            if submit_sup:
                cursor.execute("SELECT * FROM admins WHERE username = %s", (username,))
                if cursor.fetchone():
                    st.warning("âš ï¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ù‹Ø§.")
                else:
                    cursor.execute(
                        "INSERT INTO admins (full_name, username, password, role, level, mentor) VALUES (%s, %s, %s, %s, %s, %s)",
                        (full_name, username, password, 'supervisor', sp_level, sp_username)
                    )
                    conn.commit()
                    st.success("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´Ø±Ù")
                    st.rerun()


